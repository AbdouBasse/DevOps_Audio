pipeline {
    agent any   // ğŸ‘‰ Le pipeline peut s'exÃ©cuter sur n'importe quel agent Jenkins

    environment {
        PYTHON_VERSION = '3.10'   // ğŸ‘‰ Version de Python utilisÃ©e pour les modules IA
        AWS_REGION     = 'us-east-1'   // ğŸ‘‰ RÃ©gion AWS pour Terraform et EKS
        CLUSTER_NAME   = 'devops-audio-cluster'   // ğŸ‘‰ Nom du cluster EKS
    }

    stages {
        /////////////////////////////////////////
        // 1. VÃ©rification & Build Terraform
        /////////////////////////////////////////
        stage('ğŸŒ Infrastructure Terraform') {
            steps {
                echo 'ğŸ” Checkout du code source...'
                checkout scm

                echo 'âš™ï¸ Initialisation Terraform...'
                sh '''
                  cd terraform
                  terraform init
                  terraform validate
                  terraform plan -out=tfplan
                '''
            }
        }

        /////////////////////////////////////////
        // 2. Build & Push Docker image (AI Mastering)
        /////////////////////////////////////////
        stage('ğŸ§  Build AI Audio Module') {
            steps {
                echo "âš™ï¸ Installation de Python ${env.PYTHON_VERSION}..."
                sh 'sudo apt-get update && sudo apt-get install -y python3-pip'
                sh 'pip3 install -r ai-modules/requirements.txt'

                echo 'ğŸ§ Simulation de lâ€™analyse audio...'
                sh 'python3 ai-modules/beat-selection/simulate_analysis.py'

                echo 'ğŸ³ Build & Push Docker image...'
                sh '''
                  docker build -t abdou/audio-mastering:latest ./K8S
                  docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
                  docker push abdou/audio-mastering:latest
                '''
            }
        }

        /////////////////////////////////////////
        // 3. DÃ©ploiement Kubernetes (EKS)
        /////////////////////////////////////////
        stage('â˜ï¸ DÃ©ploiement Kubernetes') {
            steps {
                echo 'ğŸš€ DÃ©ploiement du microservice AI Mastering sur EKS...'
                sh '''
                  aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME}
                  kubectl apply -f ./K8S/deployment-mastering.yml
                '''
            }
        }

        /////////////////////////////////////////
        // 4. Monitoring Grafana (mock/demo)
        /////////////////////////////////////////
        stage('ğŸ“Š Monitoring Grafana') {
            steps {
                echo 'ğŸ“ˆ VÃ©rification du monitoring audio via Grafana...'
                sh 'echo "Monitoring actif (simulation)"'

                echo 'ğŸ“¤ Archivage des captures Grafana et samples audio...'
                sh '''
                  mkdir -p artifacts
                  cp -r studio-demo/grafana-captures artifacts/
                  cp -r studio-demo/samples artifacts/
                '''
                archiveArtifacts artifacts: 'artifacts/**', fingerprint: true
            }
        }
    }

    /////////////////////////////////////////
    // Post-actions : exÃ©cutÃ©es aprÃ¨s la pipeline
    /////////////////////////////////////////
    post {
        success {
            echo 'âœ… Pipeline AudioOps-Cluster terminÃ© avec succÃ¨s.'
        }
        failure {
            echo 'âŒ Ã‰chec du pipeline. VÃ©rifiez les logs.'
        }
    }
}
